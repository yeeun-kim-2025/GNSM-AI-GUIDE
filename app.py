# app.py  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (1) Streamlitì€ set_page_configë¥¼ "ìŠ¤í¬ë¦½íŠ¸ì˜ ì²« Streamlit í˜¸ì¶œ"ë¡œ
#     ë‹¨ 1íšŒë§Œ í—ˆìš©í•©ë‹ˆë‹¤. ë°˜ë“œì‹œ ë§¨ ìœ„ì—ì„œ í˜¸ì¶œí•˜ì„¸ìš”.
import streamlit as st
st.set_page_config(page_title="GNSM-AI Guide", page_icon="ğŸ˜Š", layout="centered")

# (2) ì´í›„ì— ë‹¤ë¥¸ ëª¨ë“ˆ import
import os
import utils  # utils.run_chat_assistant() ì‚¬ìš©
from manage_crawl import run_full_crawl           # ì „ì²´ ì‚¬ì´íŠ¸ í¬ë¡¤/ìƒ‰ì¸
from notice_indexer import run_full_notice_index, index_single_notice_url  # ê³µì§€ ì „ìš©

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê´€ë¦¬ì ì¸ì¦(ì¼ë°˜ ì‚¬ìš©ìì—ê²ŒëŠ” ìƒ‰ì¸ UI ìˆ¨ê¹€)
admin_ok = False
with st.sidebar:
    code = st.text_input("ê´€ë¦¬ì½”ë“œ", type="password", placeholder="ê´€ë¦¬ìë§Œ ì…ë ¥")
    if code and code == st.secrets.get("ADMIN_CODE", ""):
        admin_ok = True
        st.caption("ê´€ë¦¬ì ëª¨ë“œ ON")

# âš  ìë™ 1íšŒ ìƒ‰ì¸ì€ UIë¥¼ ì˜¤ë˜ ë¸”ë¡í•  ìˆ˜ ìˆì–´ ê¸°ë³¸ ë¹„í™œì„±í™”.
#    ê¼­ í•„ìš”í•˜ë©´ ì•„ë˜ ì¡°ê±´ì„ ì¼œì„¸ìš”(Secrets: ALLOW_AUTO_CRAWL="1")
if admin_ok and (not os.path.exists("gnsm_site.db")) and (st.secrets.get("ALLOW_AUTO_CRAWL", "0") == "1"):
    with st.spinner("ì´ˆê¸° ìƒ‰ì¸ ì¤‘... (1íšŒ)"):
        run_full_crawl()
        st.success("ì´ˆê¸° ìƒ‰ì¸ ì™„ë£Œ")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê´€ë¦¬ì ì „ìš© ë„êµ¬(ì¼ë°˜ ì‚¬ìš©ìì—ê² í‘œì‹œë˜ì§€ ì•ŠìŒ)
if admin_ok:
    with st.expander("ğŸ”§ ê´€ë¦¬ì | ìƒ‰ì¸/í¬ë¡¤ ë„êµ¬"):
        st.write("ì‚¬ì´íŠ¸ ì „ì²´ë¥¼ ë‹¤ì‹œ í›‘ì–´ ìµœì‹  ë‚´ìš©ì„ ìƒ‰ì¸í•©ë‹ˆë‹¤. (ì‹œê°„ ì†Œìš”)")
        if st.button("ì „ì²´ ì‚¬ì´íŠ¸ ì¬í¬ë¡¤ë§ ì‹¤í–‰"):
            with st.spinner("í¬ë¡¤ë§/ìƒ‰ì¸ ì¤‘..."):
                run_full_crawl()
            st.success("ì™„ë£Œ!")

        st.write("ê³µì§€ ì „ìš© ì „ì²´ ìƒ‰ì¸(ê³µì§€ ê²½ë¡œë§Œ ë¹ ë¥´ê²Œ ìˆ˜ì§‘).")
        if st.button("ê³µì§€ ì „ìš© ì „ì²´ ì¬ìƒ‰ì¸ ì‹¤í–‰"):
            with st.spinner("ê³µì§€ ìƒ‰ì¸ ì¤‘..."):
                run_full_notice_index()
            st.success("ì™„ë£Œ!")

        one = st.text_input("ë‹¨ì¼ ê³µì§€ URL ì¦‰ì‹œ ìƒ‰ì¸")
        if st.button("ì´ URLë§Œ ì¦‰ì‹œ ìƒ‰ì¸"):
            if one.strip():
                ok = index_single_notice_url(one.strip())
                st.success("ìƒ‰ì¸ ì™„ë£Œ!" if ok else "í—ˆìš©ë˜ì§€ ì•ŠëŠ” URL ë˜ëŠ” ì‹¤íŒ¨")

st.divider()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë‹‰ë„¤ì„ ê²Œì´íŠ¸ â†’ ë³„ëª… ì…ë ¥ í›„ ë³¸ ëŒ€í™” UI í‘œì‹œ
if "nickname" not in st.session_state:
    st.markdown(
        "<h1 style='text-align:center;'>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹<br>êµ­ë¦½ê³¼ì²œê³¼í•™ê´€ AI ê°€ì´ë“œì…ë‹ˆë‹¤!</h1>",
        unsafe_allow_html=True,
    )
    nickname = st.text_input("ë³„ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš” ğŸ’«", key="nickname_input")
    if st.button("ì…ì¥í•˜ê¸° ğŸšª"):
        if nickname.strip():
            st.session_state.nickname = nickname.strip()
            st.rerun()   # ë³„ëª… ì €ì¥ í›„ UI ì¬ë Œë”
        else:
            st.warning("ë³„ëª…ì„ ì…ë ¥í•´ì•¼ ì…ì¥í•  ìˆ˜ ìˆì–´ìš”!")
    st.stop()  # ë³„ëª… ì…ë ¥ ì „ì—” ì•„ë˜ ì±—ë´‡ UI ë Œë” ì•ˆ í•¨

# ë³„ëª… ì¸ì‚¬
st.markdown(
    f"<h2 style='text-align:center; color:#FFD43B;'>ë°˜ê°€ì›Œìš”, {st.session_state.nickname}ë‹˜! ğŸŒ </h2>",
    unsafe_allow_html=True,
)
st.divider()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë©”ì¸ ì±—ë´‡ UI (utils.run_chat_assistant ë‚´ë¶€ì—ì„œ Streamlit ì‚¬ìš©)
utils.run_chat_assistant()
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
